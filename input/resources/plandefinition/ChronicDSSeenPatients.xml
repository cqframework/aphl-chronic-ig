<?xml version="1.0" encoding="UTF-8"?>
<PlanDefinition
    xmlns="http://hl7.org/fhir">
    <id value="ChronicDSSeenPatients"/>
    <url value="http://hl7.org/fhir/us/chronic-ds/PlanDefinition/ChronicDSSeenPatients"/>
    <name value="ChronicDSSeenPatients"/>
    <title value="Chronic Disease Surveillance Reporting Specification for Seen Patients Cohort"/>
    <type>
        <coding>
            <system value="http://terminology.hl7.org/CodeSystem/plan-definition-type"/>
            <code value="workflow-definition"/>
            <display value="Workflow Definition"/>
        </coding>
    </type>
    <status value="active"/>
    <experimental value="true"/>
    <date value="2020-07-31T12:32:29.858-05:00"/>
    <publisher value="HL7 Public Health Work Group"/>
    <description value="Reporting specification for Chronic Disease Surveillance for Seen Patients Cohort"/>
    <jurisdiction>
        <coding>
            <system value="urn:iso:std:iso:3166"/>
            <code value="US"/>
            <display value="United States of America"/>
        </coding>
        <text value="United States of America"/>
    </jurisdiction>
    <effectivePeriod>
        <start value="2021-06-01"/>
    </effectivePeriod>
    <!-- TODO: Update this to the value sets required by the measures used
    <relatedArtifact>
        <type value="depends-on"/>
        <label value="RCTC Value Set Library of Trigger Codes"/>
        <resource value="http://hl7.org/fhir/us/ecr/Library/library-rctc"/>
    </relatedArtifact>
    -->
    <library value="http://hl7.org/fhir/us/chronic-ds/Library/SeenPatients"/>
    <action id="start">
        <description value="This action represents the start of the reporting workflow in response to the encounter-end event"/>
        <textEquivalent value="Start the reporting workflow in response to an encounter-end event"/>
        <code>
            <coding>
                <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
                <code value="initiate-reporting-workflow"/>
            </coding>
        </code>
        <trigger id="encounter-end">
            <type value="named-event"/>
            <name value="encounter-end"/>
        </trigger>
        <relatedAction>
            <actionId value="evaluate-measure"/>
            <relationship value="before-start"/>
            <offsetDuration>
                <value value="24"/>
                <system value="http://unitsofmeasure.org"/>
                <code value="h"/>
            </offsetDuration>
        </relatedAction>
    </action>
    <action id="evaluate-measure">
        <description value="This action represents the evaluation of the measure."/>
        <textEquivalent value="Evaluate measure"/>
        <code>
            <coding>
                <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
                <code value="evaluate-measure"/>
            </coding>
        </code>
        <input id="patient">
            <type value="Patient"/>
        </input>
        <input id="conditions">
            <type value="Condition"/>
        </input>
        <input id="encounter">
            <type value="Encounter"/>
        </input>
        <input id="mr">
            <type value="MedicationRequest"/>
        </input>
        <input id="obs">
            <type value="Observation"/>
        </input>
        <output id="measurereport">
            <type value="MeasureReport"/>
            <profile value="http://hl7.org/fhir/MeasureReport"/>
        </output>
        <relatedAction>
            <actionId value="report-ds"/>
            <relationship value="before-start"/>
        </relatedAction>
        <definitionCanonical value = "http://hl7.org/fhir/us/chronic-ds/Measure/SeenPatients"/>
    </action>
    <action id="report-ds">
        <description value="This action represents the reporting of the Chronic Disease Surveillance event."/>
        <textEquivalent value="Report Chronic Disease Surveillance"/>
        <code>
          <coding>
            <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
            <code value="execute-reporting-workflow"/>
          </coding>
        </code>
        <input id="measurereport">
            <type value="MeasureReport"/>
        </input>
        <condition>
            <kind value="applicability"/>
            <expression>
                <language value="text/fhirpath"/>
                <expression value="%measurereport.exists() and %measurereport.group.select(population).where(code.coding.where(code = 'initial-population').exists() and count > 0).exists()"/>
            </expression>
        </condition>
        <action id="create-eicr">
            <description value="This action invokes the creation of the eICR report."/>
            <textEquivalent value="Create eICR"/>
            <code>
              <coding>
                <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
                <code value="create-report"/>
              </coding>
            </code>
            <input id="patient">
                <type value="Patient"/>
            </input>
            <input id="conditions">
                <type value="Condition"/>
            </input>
            <input id="encounter">
                <type value="Encounter"/>
            </input>
            <input id="mr">
                <type value="MedicationRequest"/>
            </input>
            <input id="obs">
                <type value="Observation"/>
            </input>
            <input id="measurereport">
                <type value="MeasureReport"/>
            </input>
            <output id ="eicr-report-ChronicDSSeenPatients">
                <type value="Bundle"/>
                <profile value="http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-measurereport-bundle"/>
            </output>
            <relatedAction>
                <actionId value="validate-eicr"/>
                <relationship value="before-start"/>
            </relatedAction>
        </action>
        <action id="validate-eicr">
            <description value="This action represents the validation of the eICR."/>
            <textEquivalent value="Validate eICR"/>
            <code>
                <coding>
                    <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
                    <code value="validate-report"/>
                </coding>
            </code>
            <input id="eicr-report-ChronicDSSeenPatients">
                <type value="Bundle"/>
                <extension url="http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension">
                    <valueString value="eicr-report-ChronicDSSeenPatients"/>
                </extension>
            </input>
            <output id="validated-eicr-report">
                <type value="Bundle"/>
                <profile value="http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"/>
            </output>
            <relatedAction>
                <actionId value="submit-eicr"/>
                <relationship value="before-start"/>
            </relatedAction>
        </action>
        <action id="submit-eicr">
            <description value="This action represents the validation of the eICR."/>
            <textEquivalent value="Submit eICR"/>
            <code>
                <coding>
                    <system value="http://hl7.org/fhir/us/medmorph/CodeSystem/us-ph-plandefinition-actions"/>
                    <code value="submit-report"/>
                </coding>
            </code>
            <input id="validated-eicr-report">
                <type value="Bundle"/>
                <extension url="http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension">
                    <valueString value="validated-eicr-report"/>
                </extension>
            </input>
            <output id="eicr-report-submitted">
                <type value="Bundle"/>
                <profile value="http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"/>
            </output>
        </action>
    </action>
</PlanDefinition>
